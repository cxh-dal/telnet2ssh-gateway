# 架构设计文档

## 系统架构

### 整体架构

```
┌─────────────┐         SSH加密          ┌──────────────────┐        Telnet明文        ┌─────────────┐
│             │  ──────────────────────► │                  │  ────────────────────►  │             │
│  SSH客户端  │   4001-4032端口         │  代理服务器       │   23/其他端口           │  Telnet设备 │
│             │  ◄────────────────────── │  (Docker容器)    │  ◄────────────────────  │             │
└─────────────┘                          └──────────────────┘                          └─────────────┘
                                                 │
                                                 ▼
                                         ┌───────────────┐
                                         │  config.yaml  │
                                         │  端口映射配置  │
                                         └───────────────┘
```

### 核心组件

#### 1. ProxyManager (代理管理器)
- 职责: 管理所有SSH代理服务器实例
- 功能:
  - 加载和解析配置文件
  - 生成和管理SSH主机密钥
  - 启动/停止多个SSH代理服务器
  - 日志配置和管理

#### 2. SSHProxyServer (SSH代理服务器)
- 职责: 为单个端口提供SSH服务
- 功能:
  - 监听指定的SSH端口
  - 接受SSH客户端连接
  - 验证用户身份
  - 为每个连接创建ProxySession

#### 3. SSHServerHandler (SSH服务器处理器)
- 职责: 处理SSH协议相关的认证和会话
- 功能:
  - 密码认证
  - PTY请求处理
  - Shell会话管理
  - 命令执行请求

#### 4. ProxySession (代理会话)
- 职责: 处理SSH和Telnet之间的数据转发
- 功能:
  - 连接到Telnet后端
  - SSH → Telnet 数据转发
  - Telnet → SSH 数据转发
  - 双向透明传输
  - 会话清理

#### 5. TelnetClient (Telnet客户端)
- 职责: 管理到Telnet后端的连接
- 功能:
  - 建立Telnet连接
  - 发送/接收原始数据
  - 连接管理

### 数据流

```
1. SSH客户端连接
   │
   ▼
2. SSHProxyServer接受连接
   │
   ▼
3. SSHServerHandler验证身份
   │
   ▼
4. 创建ProxySession
   │
   ▼
5. TelnetClient连接后端
   │
   ▼
6. 启动双向数据转发
   │
   ├──► SSH → Telnet (线程1)
   │
   └──► Telnet → SSH (线程2)
```

### 线程模型

```
主线程 (ProxyManager)
  │
  ├─► SSH服务器线程 (端口4001)
  │     └─► 客户端处理线程1
  │     └─► 客户端处理线程2
  │           ├─► SSH→Telnet转发线程
  │           └─► Telnet→SSH转发线程
  │
  ├─► SSH服务器线程 (端口4002)
  │     └─► ...
  │
  └─► SSH服务器线程 (端口4003-4032)
        └─► ...
```

## 配置管理

### 配置文件结构

```yaml
ssh:                    # SSH服务器配置
  host: 监听地址
  username: 用户名
  password: 密码
  host_key: 密钥路径

mappings:               # 端口映射
  4001:                 # SSH端口
    host: Telnet地址   
    port: Telnet端口
    enabled: 是否启用
    description: 描述

logging:                # 日志配置
  level: 日志级别
  file: 日志文件
  max_bytes: 最大大小
  backup_count: 保留数量

health_check:           # 健康检查
  enabled: 是否启用
  interval: 检查间隔
  timeout: 超时时间
```

### 配置加载流程

```
启动 → 加载config.yaml → 验证配置 → 生成SSH密钥 → 启动服务器
```

## 管理工具

### manage.py
- 端口映射的增删改查
- 启用/禁用映射
- 配置文件操作

### health_check.py
- 端口可用性检查
- 服务健康状态
- 用于Docker健康检查

### monitor.py
- 持续监控服务
- 统计分析
- 告警功能

## Docker部署

### 容器架构

```
Docker容器
  ├── /app
  │   ├── proxy_server.py      # 主程序
  │   ├── manage.py            # 管理工具
  │   ├── health_check.py      # 健康检查
  │   ├── config.yaml          # 配置文件 (挂载)
  │   ├── /data               # 数据目录 (挂载)
  │   │   └── ssh_host_key    # SSH密钥
  │   └── /logs               # 日志目录 (挂载)
  │       └── proxy.log
  │
  └── 暴露端口: 4001-4032
```

### 健康检查机制

```
Docker Healthcheck
  │
  ▼
health_check.py
  │
  ├─► 检查启用的端口
  │
  ├─► 尝试连接每个端口
  │
  ├─► 所有端口正常 → 健康
  │
  └─► 任一端口异常 → 不健康
        │
        ▼
      Docker自动重启容器
```

## 安全设计

### 1. 认证
- SSH密码认证
- 可配置用户名密码
- 建议生产环境修改默认密码

### 2. 加密
- SSH协议加密客户端到代理的流量
- RSA 2048位密钥
- 自动生成主机密钥

### 3. 网络隔离
- 代理到Telnet的流量应在可信网络
- 建议防火墙限制SSH访问来源
- 支持绑定特定IP

### 4. 日志审计
- 所有连接记录日志
- 认证成功/失败记录
- 日志轮转保留历史

## 性能优化

### 1. 并发处理
- 多线程模型
- 每个SSH服务器独立线程
- 每个客户端独立处理线程

### 2. 数据转发
- 4KB缓冲区
- 非阻塞I/O
- select模型监听

### 3. 资源限制
- 可配置Docker资源限制
- 连接超时机制
- 自动清理断开的连接

## 错误处理

### 1. 连接失败
- Telnet后端不可达
- 自动清理会话
- 向SSH客户端发送错误消息

### 2. 会话异常
- 任一方向断开
- 自动终止双向转发
- 清理资源

### 3. 服务异常
- 健康检查失败
- Docker自动重启
- 保留日志用于诊断

## 扩展性

### 水平扩展
```
负载均衡器
  │
  ├─► 代理实例1 (端口4001-4016)
  │
  ├─► 代理实例2 (端口4017-4032)
  │
  └─► 代理实例N
```

### 功能扩展
- 支持其他认证方式（公钥认证）
- 支持会话录制
- 支持访问控制列表
- 支持Metrics导出
- 支持分布式配置

## 监控指标

### 关键指标
- 活跃连接数
- 连接成功率
- 连接延迟
- 数据吞吐量
- 错误率

### 监控方式
- Docker日志
- health_check.py
- monitor.py持续监控
- 可集成Prometheus/Grafana

## 故障恢复

### 自动恢复
1. 健康检查失败 → Docker重启容器
2. 配置错误 → 日志记录，跳过该端口
3. Telnet后端不可达 → 向SSH客户端报错

### 手动恢复
1. 查看日志: `docker logs telnet-ssh-proxy`
2. 运行诊断: `./troubleshoot.sh`
3. 重启服务: `./stop.sh && ./start.sh`
4. 检查配置: `python manage.py list`

## 最佳实践

### 生产环境部署
1. ✓ 修改默认密码
2. ✓ 限制访问IP
3. ✓ 配置资源限制
4. ✓ 定期备份配置和密钥
5. ✓ 启用日志收集
6. ✓ 配置监控告警
7. ✓ 使用系统服务管理
8. ✓ 定期检查更新

### 安全加固
1. ✓ 使用强密码
2. ✓ 限制网络访问
3. ✓ 定期审计日志
4. ✓ 最小权限原则
5. ✓ 网络隔离
6. ✓ 定期更新依赖

## 技术栈

### 核心技术
- **Python 3.11**: 主要编程语言
- **Paramiko**: SSH协议实现
- **Socket**: 网络通信
- **Threading**: 并发处理

### 部署技术
- **Docker**: 容器化
- **Docker Compose**: 编排
- **YAML**: 配置管理

### 工具技术
- **argparse**: 命令行参数
- **logging**: 日志管理
- **select**: I/O多路复用

## 未来计划

### 短期
- [ ] 添加公钥认证支持
- [ ] 添加会话录制功能
- [ ] 优化性能和资源使用
- [ ] 添加更多监控指标

### 长期
- [ ] Web管理界面
- [ ] 支持其他协议代理
- [ ] 分布式部署支持
- [ ] 高可用集群模式
